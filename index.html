<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pok√©mon Classifier</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
</head>
<body>
    <h1>Is this Bulbasaur, Pikachu, or Charmander?</h1>
    <input type="file" id="imageUpload" accept="image/*" />
    <br><br>
    <canvas id="canvas" width="32" height="32" style="display:none;"></canvas>
    <p id="result">Upload an image to see the result.</p>

    <script>
        const labels = ["Bulbasaur", "Pikachu", "Charmander"];
        const CONFIDENCE_THRESHOLD = 0.7;
        let session;

        async function loadModel() {
            document.getElementById('result').innerText = "Loading model...";
            session = await ort.InferenceSession.create("pokemon_model.onnx");
            document.getElementById('result').innerText = "Model loaded. Upload an image!";
        }

        function softmax(arr) {
            const C = Math.max(...arr);
            const d = arr.map((y) => Math.exp(y - C)).reduce((a, b) => a + b);
            return arr.map((value) => Math.exp(value - C) / d);
        }

        function preprocessImage(imageData) {
            const float32Data = new Float32Array(3 * 32 * 32);
            for (let i = 0; i < 32 * 32; i++) {
                const r = imageData[i * 4] / 255;
                const g = imageData[i * 4 + 1] / 255;
                const b = imageData[i * 4 + 2] / 255;
                float32Data[i] = r;                     // R channel
                float32Data[1024 + i] = g;              // G channel
                float32Data[2048 + i] = b;              // B channel
            }
            return new ort.Tensor("float32", float32Data, [1, 3, 32, 32]);
        }

        document.getElementById('imageUpload').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file || !session) return;

            const img = new Image();
            img.onload = async () => {
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, 32, 32);
                const imageData = ctx.getImageData(0, 0, 32, 32).data;

                const inputTensor = preprocessImage(imageData);
                const feeds = {};
                feeds[session.inputNames[0]] = inputTensor;

                const output = await session.run(feeds);
                const outputData = output[session.outputNames[0]].data;

                const probabilities = softmax(Array.from(outputData));
                const maxProb = Math.max(...probabilities);
                const maxIndex = probabilities.indexOf(maxProb);

                const resultText = maxProb >= CONFIDENCE_THRESHOLD
                    ? `Prediction: ${labels[maxIndex]} (Confidence: ${(maxProb * 100).toFixed(2)}%)`
                    : "I don't think this is a Bulbasaur, Pikachu, or Charmander.";

                document.getElementById('result').innerText = resultText;
            };

            img.src = URL.createObjectURL(file);
        });

        loadModel();
    </script>
</body>
</html>


